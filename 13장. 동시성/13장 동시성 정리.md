## 13장 동시성(**Concurrency**)

### 동시성이란?

- 동시에 여러 작업을 처리하는 것
- 컴퓨터에서는 여러 스레드(thread)나 프로세스(process)가 동시에 실행되면서 프로그램이 더 빠르고 효율적으로 동작하게 한다.
- 단, 이 ‘동시에’가 완전히 동시에 일어나는 경우도 있지만, 보통은 CPU가 빠르게 작업을 번갈아가며 실행하는 것이라 ‘논리적 동시성‘이 많다.

### 동시성 관련 주요 개념

| 개념 | 설명 |
| --- | --- |
| 스레드(Thread) | CPU에서 실행되는 가장 작은 작업 단위 |
| 프로세스(Process) | 실행 중인 프로그램 전체 |
| 공유 자원 | 여러 스레드가 동시에 접근하는 데이터나 리소스 |
| 동기화(Synchronization) | 여러 스레드가 공유 자원에 안전하게 접근하도록 제어하는 기법 |
| 경쟁 상태(Race Condition) | 여러 스레드가 동시에 공유 자원에 접근해 데이터 불일치 발생 상황 |
| 교착 상태(Deadlock) | 서로 자원을 기다리며 작업이 멈춰버리는 상황 |

### 1. 여러 스레드를 동시에 돌리는 이유 → 효율성 향상과 응답성 개선

- 작업을 병렬로 처리해서 전체 처리 속도를 높이기 위해
예 : 서버에서는 여러 사용자의 요청을 동시에 처리해야 하기때문에 여러 스레드가 각기 다른 작업을 병렬로 수행함으로써 처리량을 늘린다.
- 사용자 인터페이스를 부드럽게 유지하기 위해 무거운 작업을 백그라운드에 스레드에서 처리하고, 메인 스레드는 사용자 입력에 바로 반응 할 수 있게 해서 앱이나 프로그램이 멈추기 않도록 한다.
- 자원을 최대한 활용하기 위해 
CPU 코어가 여러 개일 때, 여러 스레드가 동시에 일하면 CPU 활용율이 올라가고, 자원을 낭비하지 않게 된다.

→ 여러스레드를 동시에 돌리는 이유는 성능과 사용자 경험을 동시에 높이려는 목적이 크다.

⇒ 하지만 동시성 처리 실패 시 데이터 경쟁, 교착 상태 같은 문제가 발생할 수 있다.

### 2. 동시성의 어려움과 문제점

- **어려움**
    - **복잡성 증가** : 코드의 이해와 디버깅이 어려워진다. 실행 순서를 예측하기 힘들고, 테스트 케이스 작성이 복잡해진다.
    - **경쟁조건(Race Condition)** : 동시성 코드는 여러 흐름(스레드)이 동시에 같은 자원에 접근하면서 예상치 못한 결과가 생길 수 있다. 컴퓨터는 빠르게 스레드를 전환하면서 실행하기 때문에 타이밍에 따라 결과가 달라진다.
- **문제점**
    - **데드락(Deadlock)** : 두 개 이상의 스레드가 서로 상대방의 락이 해제되기를 기다리며 무한 대기 상태에 빠진다.
    - **라이브락(Livelock)** : 스레드들이 데드락을 피하려고 계속 상태를 변경하지만 실질적인 진전이 없는 상황이다.
    - **기아 상태(Starvation)** : 특정 스레드가 계속해서 자원을 할당 받지 못 하는 상황이다.
- **난관**
    
    ```java
    	// 공유 자원
    private int counter = 0;
    
    // 동기화 없이 수정하면 문제 생김
    public void increment() {
        counter++;  // 위험: 여러 스레드가 동시에 접근하면 값이 꼬임
    }
    
    // 동기화 적용 예
    public synchronized void safeIncrement() {
        counter++;  // 한 번에 하나의 스레드만 접근 가능
    }
    
    /*
    	•	increment()는 동기화 없어서 경쟁 조건 발생 위험 높음.
    	•	safeIncrement()는 synchronized 키워드로 동기화해서 안전.
    */
    ```
    

### 3. 어려움에 대처하고 깨끗한 코드를 작성하는 방법

> 동시성은 단순히 코드를 효율적으로 돌리는 기술이 아니라, 설계 단계부터 **'데이터와 스레드가 어떻게 상호작용할지'**를 근본적으로 고민해야 하는 영역이다. 저자는 동시성 관련 버그는 예측하기 어렵고 재현하기도 힘들기 때문에, 이를 다루는 코드는 철저하게 분리하고, 검증하며, 작은 단위로 제어해야 한다고 강조하고 있다.
> 

### 4. 클린 코드에서 강조하는 동시성 코드 작성법

- **동시성 방어원칙**
    - **단일 책임 원칙(SRP)** : 동시성과 관련된 코드는 다른 비즈니스 로직과 철저히 분리해야 한다. 이를 위해 **단일 책임 원칙(SRP)**을 적극적으로 적용해서, 동시성 관리를 전담하는 클래스를 따로 만들어야한다.
    - **자료 범위 제한 - 불필요한 공유 상태를 줄이기**
        - 공유하는 데이터가 많으면 많을수록 버그 발생 확률 증가한다.
        따라서 공유 상태를 최소화하고, 가능하면 불변(immutable) 객체를 사용 한다.
        데이터가 변경되지 않는 구조라면 동기화가 훨씬 간단해진다.
    - **자료 사본 사용** : 가능하다면 공유 자원의 사본을 만들어 각 스레드가 독립적으로 작업하도록 하는 것이 좋다.
    - **라이브러리 활용과 실행 모델의 이해**

### **5. 테스트 전략**

- **올바른 코드 작성** : 먼저 단일 스레드에서 올바르게 동작하는 코드를 작성한다.
- **스레드 코드 분리** : 동시성과 관련된 코드를 별도의 클래스나 메서드로 분리한다.
- **다양한 환경에서 테스트** : 다른 플랫폼, 다른 설정에서 반복 테스트를 수행한다.
- **부하 테스트** : 많은 스레드로 오랜 시간 실행하여 문제점을 찾아낸다.
- **코드 검토** : 동시성 코드는 특히 꼼꼼한 검토가 필요하다.

  ---

## 생각해보자
  ### 4. 동시성 관련 알고리즘과 메커니즘

- **동시성 버그가 발생하는 원인을 이해하려면**
    - 스레드 스케줄링, 락(lock), 뮤텍스, 세마포어, 원자성(atomicity), 메모리 모델 등 기본 개념을 알아야 한다. 이걸 모르면 버그를 찾거나 예방하기가 거의 불가능함.
- **관련 알고리즘**
    - 자바라면 synchronized, volatile, Atomic 클래스, ExecutorService 등
    - 자바스크립트는 비동기 콜백, 프로미스, async/await, 이벤트 루프 개념
    - 파이썬은 GIL(Global Interpreter Lock), 스레딩과 멀티프로세싱 차이 등

<aside>
💡

### 요약 정리

- **라이브러리 활용**
    - **스레드 안전 컬렉션** : java.util.concurrent 패키지의 ConcurrentHashMap, BlockingQueue 등을 활용하여 동시성 문제를 해결할 수 있다.
    - **executor 프레임워크** : 스레드 풀을 관리하고 작업을 효율적으로 분배할 수 있는 ThreadPoolExecutor, ForkJoinPool 등을 사용한다.
    - **동기화 클래스** : CountDownLatch, Semaphore, CyclicBarrier 등을 활용하여 스레드 간 협력을 구현한다.
- **실행모델의 이해**
    - **Producer-Consumer** : 생산자가 데이터를 생성하고 소비자가 처리하는 패턴. 큐를 통해 데이터를 전달한다.
    - **Readers-Writers** : 읽기 작업과 쓰기 작업을 구분하여 처리하는 패턴. 여러 읽기 작업은 동시에 가능하지만, 쓰기 작업은 독점적으로 수행된다.
    - **Dining Philosophers** : 제한된 자원을 여러 프로세스가 공유할 때 발생하는 문제를 다루는 고전적인 동시성 문제이다.
- **동기화하는 메서드 사이에 존재하는 의존성 이해**
    - **synchronized 키워드** : 메서드나 블록 단위로 동기화를 구현. 간단하지만 성능 오버헤드가 있을 수 있다.
    - **Lock 인터페이스** : ReentrantLock, ReadWriteLock 등을 사용하여 더 세밀한 제어가 가능하다.
    - **Atomic 클래스** : AtomicInteger, AtomicReference 등을 사용하여 락 없이도 스레드가 안전한 연산을 수행할 수 있다
</aside>

### 5. 퀴즈

정보처리기사 21년 1회 기출문제 

1. 교착상태가 발생할 수 있는 조건이 아닌것은?

1) Mutual exclusion
2) Hold and wait
3) Non-Preemption
4) Linear Wait

<aside>
💡

### 교착상태 발생조건(필수 4가지)

| Mutual Exclusion (상호 배제) | 자원은 한 번에 하나의 프로세스만 사용 할 수 있음 |
| --- | --- |
| Hold and Wait (점유 대기) | 자원을 점유한 채, 다른 자원을 기다림 |
| No Preemption (비선점) | 자원을 강제로 빼앗을 수 없음 |
| Circular Wait (순환대기) | 프로세스들이 자원을 원형으로 기다림
예: P1 → P2 → … → P1 |
</aside>
